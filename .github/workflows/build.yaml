name: Build images

on:
  push:

env:
  BASE_IMAGE_NAME: openvk
  DB_IMAGE_NAME: mariadb
  EVENT_IMAGE_NAME: mariadb
  DB_VERSION: "10.9"

jobs:
  build:
    runs-on: ubuntu-latest

    if: github.event_name == 'push'
    steps:
      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3
      
      - name: Set up Docker Buildx
        id: buildx
        uses: docker/setup-buildx-action@v3

      - name: Change repository string to lowercase
        id: repositorystring
        uses: Entepotenz/change-string-case-action-min-dependencies@v1.1.0
        with:
          string: ${{ github.repository }}

      # - name: Log into registry
      #   run: echo "${{ secrets.GITHUB_TOKEN }}" | docker login ghcr.io -u ${{ github.actor }} --password-stdin

      - name: Build base image
        uses: docker/build-push-action@v6
        with:
          tags: ghcr.io/${{ steps.repositorystring.outputs.lowercase }}/${{env.BASE_IMAGE_NAME}}:test
          platforms: linux/amd64,linux/arm64
          file: install/automated/docker/openvk.Dockerfile
          outputs: type=oci,dest=/tmp/openvk.tar
          build-args: |
            GITREPO=${{ steps.repositorystring.outputs.lowercase }}
      
      - name: Build MariaDB primary image
        uses: docker/build-push-action@v6
        with:
          tags: ghcr.io/${{ steps.repositorystring.outputs.lowercase }}/${{env.DB_IMAGE_NAME}}:${{env.DB_VERSION}}-primary
          platforms: linux/amd64,linux/arm64
          file: install/automated/docker/mariadb-primary.Dockerfile
          outputs: type=oci,dest=/tmp/mariadb-primary.tar
          build-args: |
            VERSION=${{env.DB_VERSION}}
      
      - name: Build MariaDB event image
        uses: docker/build-push-action@v6
        with:
          tags: ghcr.io/${{ steps.repositorystring.outputs.lowercase }}/${{env.DB_IMAGE_NAME}}:${{env.DB_VERSION}}-eventdb
          platforms: linux/amd64,linux/arm64
          file: install/automated/docker/mariadb-eventdb.Dockerfile
          outputs: type=oci,dest=/tmp/mariadb-eventdb.tar
          build-args: |
            VERSION=${{env.DB_VERSION}}
      
      - name: Upload base image as an artifact
        uses: actions/upload-artifact@v4
        with:
          name: openvk
          path: /tmp/openvk.tar
      
      - name: Upload MariaDB primary as an artifact
        uses: actions/upload-artifact@v4
        with:
          name: mariadb-primary
          path: /tmp/mariadb-primary.tar
      
      - name: Upload MariaDB event as an artifact
        uses: actions/upload-artifact@v4
        with:
          name: mariadb-eventdb
          path: /tmp/mariadb-eventdb.tar